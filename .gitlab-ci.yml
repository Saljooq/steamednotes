variables:
  REPO_URL: "https://gitlab.com/saljooq/steamednotes.git"

stages:
 - terraform
 - deploy

terraform_setup:
  stage: terraform
  image: registry.gitlab.com/gitlab-org/terraform-images/stable:latest
  script:
    - cd terraform
    - terraform init
    - terraform plan
    - terraform apply -auto-approve
    - terraform output -raw ec2_public_ip
  when: manual


# Reusable SSH base job
.ssh_base:
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client docker docker-compose git
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - EC2_HOST=$(cat ec2_public_ip.txt)
    - ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts



deploy_to_ec2:
  extends: .ssh_base
  stage: deploy
  script:
    - ssh -i ~/.ssh/id_rsa ubuntu@$EC2_HOST << 'EOF'
        sudo fuser -k 80/tcp || true 
        sudo fuser -k 8080/tcp || true 
        sudo apt update -y
        sudo apt install -y docker.io git
        sudo systemctl start docker
        sudo usermod -a -G docker ubuntu
        sudo apt install -y docker-compose
        git clone --depth=1 $REPO_URL app
        cd app
        docker-compose up -d
      EOF
  when: manual